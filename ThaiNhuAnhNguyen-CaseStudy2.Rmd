---
title: "Analyst - Digital & Data Analytics Practice @ Stout - Case Study"
author: "Thai Nhu Anh Nguyen"
date: "06/07/2022"
output:
  html_document: default
  pdf_document: default
---

```{r}
# Load libraries
library(tidyverse)
library(tidyr)
library(ggplot2)
library(DataExplorer)
library(randomForest)
library(usmap)
library(maps)
library(caret)
```

## Case Study 2

```{r}
# Load the data
casestudy <- read.csv("casestudy.csv", header = T)
head(casestudy)

# Check if there is any NA
any(is.na(casestudy))
```

* **Total revenue for the current year (2015, 2016 and 2017)**

```{r}
casestudy %>% 
  group_by(year) %>% 
  summarise(total_revenue = sum(net_revenue)) -> total_revenue
total_revenue
```

* **New Customer Revenue e.g. new customers not present in previous year only**

So there are no new customers for 2015 due to the limit of the dataset

New customer in 2016 = Customer orders appear in only 2016 not 2015

New customer in 2017 = Customer orders appear in only 2017 not 2016


```{r}
# Get customer orders in 2017
customer_2017 <- casestudy %>% 
  filter( year == 2017) 

# Get customer orders in 2016
customer_2016 <- casestudy %>% 
  filter( year == 2016)

# Get customer orders in 2015
customer_2015 <- casestudy %>% 
  filter( year == 2015)

# Get customer orders appear in 2017 but not 2016
new_customer_2017 <- anti_join(customer_2017, customer_2016, by = "customer_email")

# Get customer orders appear in 2016 but not 2015
new_customer_2016 <- anti_join(customer_2016, customer_2015, by = "customer_email")

# Calculate the customer revenue
new_customer_2017 %>%
summarise(Revenue_new_customer_2017 = sum(net_revenue))

# Calculate the customer revenue
new_customer_2016 %>%
summarise(Revenue_new_customer_2016 = sum(net_revenue))
```


*	**Existing Customer Growth. To calculate this, use the Revenue of existing customers for current year â€“(minus) Revenue of existing customers from the previous year**

I define existing customer growth as the revenue generated by the existing customers within a year. Therefore, 

* Existing Customer Growth for 2016 = Net Revenue for Existing Customer in 2016

```{r}
# Find all customers from 2015 that appear in 2016 also
customer_2015 %>% 
  inner_join(customer_2016, by = "customer_email") %>%
  mutate(existing_growth_2016 = net_revenue.y - net_revenue.x) -> data
sum(data$existing_growth_2016)
```

* Existing Customer Growth for 2017 = Net Revenue for Existing Customer in 2017

```{r}
# Find all customers from 2016 that appear in 2017 also
customer_2016 %>% 
  inner_join(customer_2017, by = "customer_email") %>%
  mutate(existing_growth_2017 = net_revenue.y - net_revenue.x) -> data
sum(data$existing_growth_2017)
```

*	**Revenue lost from attrition**

I define revenue lost from attrition as the loss of business revenue from one period to the next. Therefore, similar to question 2, there is no revenue attrition for 2015 due to lack of information. In other words,

* Revenue attrition for 2016 = Revenue from customers in 2015 but not appearing in 2016

```{r}
# Find all customers from 2015 but do not return in 2016
customer_2015 %>% 
  anti_join(customer_2016, by = "customer_email") %>% 
  summarise(revenue_attrition_2016 = sum(net_revenue))
```

* Revenue attrition for 2017 = Revenue from customers in 2016 but not appearing in 2017

```{r}
# Find all customers from 2016 but do not return in 2017
customer_2016 %>% 
  anti_join(customer_2017, by = "customer_email") %>% 
  summarise(revenue_attrition_2017 = sum(net_revenue))
```

*	**Existing Customer Revenue Current Year**

I define existing customer revenue for the current year as the sum of revenue of all customer existing in previous year that appear in the current year

* Existing Customer Revenue 2016 = The total of revenue of existing customer of 2015 that appear in 2016

```{r}
# return all rows from 2016 with a match in 2015
customer_2016 %>%
  semi_join(customer_2015, by = "customer_email") %>% 
  # Sum the revenue of existing customer
  summarise(existing_revenue_2016 = sum(net_revenue))
```

* Existing Customer Revenue 2017 = The total of revenue of existing customer of 2016 that appear in 2017

```{r}
# return all rows from 2017 with a match in 2016
customer_2017 %>%
  semi_join(customer_2016, by = "customer_email") %>% 
  # Sum the revenue of existing customer
  summarise(existing_revenue_2016 = sum(net_revenue))
```

*	**Existing Customer Revenue Prior Year**


I define existing customer revenue for the prior year as the sum of revenue of all customer existing in previous year that return in the current year

* Existing Customer Revenue 2016 = The total of revenue in 2015 of existing customer in 2016

```{r}
# return all rows from 2016 with a match in 2015
customer_2016 %>%
  inner_join(customer_2015, by = "customer_email") %>% 
  summarise(existing_revenue_prior_year_2016 = sum(net_revenue.y))
```

* Existing Customer Revenue 2017 = The total of revenue in 2016 of existing customer in 2017

```{r}
# return all rows from 2017 with a match in 2016
customer_2017 %>%
  inner_join(customer_2016, by = "customer_email") %>% 
  summarise(existing_revenue_prior_year_2017 = sum(net_revenue.y))
```

*	**Total Customers Current Year**

The total customers are defined as the total number of unique emails.

* Total Customers in 2015 

```{r}
customer_2015 %>% 
  distinct(customer_email) %>% 
  nrow() -> total_customer_2015
total_customer_2015
```

* Total Customers in 2016

```{r}
customer_2016 %>% 
  distinct(customer_email) %>% 
  nrow() -> total_customer_2016
total_customer_2016
```

* Total Customers in 2017

```{r}
customer_2017 %>% 
  distinct(customer_email) %>% 
  nrow() -> total_customer_2017
total_customer_2017
```

*	**Total Customers Previous Year**

Total Customers of Current year 2015: 231294
Total Customers of Previous Year 2015: N/A

Total Customers of Current year 2016: 204646
Total Customers of Previous Year 2015: 231294

Total Customers of Current year 2017: 249987
Total Customers of Previous Year 2016: 204646

*	**New Customers**

I define new customers as customers that do not appear in the previous year. Therefore, there are no new customers for the year 2015 due to lack of information.

* New Customer in 2016

```{r}
# Find all customers from 2016 but do not appear in 2015
customer_2016 %>%
  anti_join(customer_2015, by = "customer_email") %>%
  distinct(customer_email) %>% 
  nrow() -> total_new_customer_2016
total_new_customer_2016
```

* New Customer in 2017

```{r}
# Find all customers from 2017 but do not appear in 2016
customer_2017 %>%
  anti_join(customer_2016, by = "customer_email") %>%
  distinct(customer_email) %>% 
  nrow() -> total_new_customer_2017
total_new_customer_2017
```

*	**Lost Customers**

I define lost customers as customers that appear in the previous year but do not return in this curren year. Therefore, there are no new customers for the year 2015 due to lack of information.

* Lost Customer in 2016

```{r}
# Find all customers from 2015 but do not appear in 2016
customer_2015 %>%
  anti_join(customer_2016, by = "customer_email") %>%
  distinct(customer_email) %>% 
  nrow() -> total_lost_customer_2016
total_lost_customer_2016
```

* Lost Customer in 2017

```{r}
# Find all customers from 2016 but do not appear in 2017
customer_2016 %>%
  anti_join(customer_2017, by = "customer_email") %>%
  distinct(customer_email) %>% 
  nrow() -> total_lost_customer_2017
total_lost_customer_2017
```

Additionally, generate a few unique plots highlighting some information from the dataset. Are there any interesting observations?


```{r}
total_customer <- tibble("total_customer" = c(total_customer_2015, total_customer_2016, total_customer_2017))
customer <- total_revenue %>% add_column(total_customer)
customer
barplot(customer$total_revenue,
        main = "Total Revenue in 2015, 2016, 2017",
        xlab = "Year",
        ylab = "Revenue", col = c("Blue", "Green", "Yellow"))
barplot(customer$total_customer,
        main = "Total Customers in 2015, 2016, 2017",
        xlab = "Year",
        ylab = "Number of Customers", col = c("Red", "Orange", "Pink"))
```

According to the plots, the trend in total revenue is identical to that of total customers in 2015, 2016, 2017. To be more specific, in 2016, there is a significant decrease in existing customers compared with new customers, thus, a slight decrease in total number of customers, hence a slight decrease in total revenue. Meanwhile in 2017, the company managed to get more new customers (229028) and lost less existing customers (183687), thus, an increase in revenue. In short, in order to generate more customers, the company needs to have better strategies in keeping existing customers, while attracting more new customers.

```{r}
boxplot(customer_2015$net_revenue, customer_2016$net_revenue, customer_2017$net_revenue,
        main = "Box Plot of Customer Revenue in 2015, 2016, and 2017",
        xlab = "Year",
        ylab = "Revenue",
        col = c("Yellow", "Blue", "Red"))
```

According to the box plot, the net revenue for each year seems to be consistent. In other words, most customers, on average, spend around the same every year. This is not a good sign of an effective business management. The company should work on customer spending stimulation and promotions to attract more customers and keep existing customers.

```{r}
# Set up a matrix to create a bar plot
table <- matrix(c(total_customer_2015, total_customer_2016, total_customer_2017, NA, total_new_customer_2016, total_new_customer_2017), nrow = 2, byrow = T)
row.names(table) <- c("total_customers", "total_new_customers")
colnames(table) <- c("2015", "2016", "2017")
barplot(table, beside = TRUE,
        main = "Bar Plot of Total Customers and \nTotal New Customers in 2015, 2016, and 2017",
        xlab = "Year",
        ylab = "Number of Customers",
        col = c("blue1", "blue4"))
```

This plot indicates that the majority of the total revenue comes from new customers and lots of existing customers left every year. In other words, the products/services may not be up to expectations or the company does not have good strategies in keeping customers. 